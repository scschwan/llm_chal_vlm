# 제조 불량 검출 및 대응 시스템 아키텍처 (ver 1.2)

## 1. 시스템 개요

### 1.1 프로젝트 범위
- **대상 사용자**: 제조 현장의 관리자 및 작업자
- **핵심 기능**: 
  1. 정상/불량 이미지 등록
  2. 대응 매뉴얼 등록
  3. 이미지 비교 및 차이 시각화
  4. 대응 매뉴얼 매칭 및 시각화
  5. LLM 기반 조치사항 안내

- **비핵심 기능** (향후 구현):
  1. 사용자별 계정 관리
  2. 업체별 프로젝트 관리
  3. 로그 분석

### 1.2 사용자 롤
| 구분 | 주요 시나리오 |
|------|--------------|
| **관리자** | 제품/매뉴얼 등록, 불량 목록 관리, 이미지 데이터 등록, 서버 배포, 대시보드 모니터링 |
| **작업자** | 검사 이미지 업로드, 유사도 검색, 불량 검출, 조치 가이드 확인, 피드백 등록 |

---

## 2. 전체 시스템 아키텍처

### 2.1 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────┐
│                          사용자 인터페이스 (Web UI)                   │
├─────────────────────────────────────────────────────────────────────┤
│  관리자 페이지                    │        작업자 페이지              │
│  ┌─────────────────────────┐    │    ┌─────────────────────────┐  │
│  │ • 제품/매뉴얼 등록      │    │    │ • 이미지 업로드          │  │
│  │ • 이미지 데이터 관리    │    │    │ • 유사도 검색 (TOP-K)    │  │
│  │ • 서버 배포 관리        │    │    │ • 불량 검출 시각화       │  │
│  │ • 통합 대시보드         │    │    │ • 조치 가이드 확인       │  │
│  │ • 불량 모델 선정        │    │    │ • 피드백 등록            │  │
│  └─────────────────────────┘    │    └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        Application Layer (FastAPI)                   │
├─────────────────────────────────────────────────────────────────────┤
│  Admin API                        │      Worker API                  │
│  ┌─────────────────────────┐    │    ┌─────────────────────────┐  │
│  │ /admin/products         │    │    │ /worker/upload           │  │
│  │ /admin/manuals          │    │    │ /worker/search           │  │
│  │ /admin/images           │    │    │ /worker/detect           │  │
│  │ /admin/deploy           │    │    │ /worker/guide            │  │
│  │ /admin/dashboard        │    │    │ /worker/feedback         │  │
│  │ /admin/models           │    │    │                          │  │
│  └─────────────────────────┘    │    └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                          Business Logic Layer                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │ Product Manager │  │  Image Manager  │  │ Manual Manager  │    │
│  │ • 제품 CRUD     │  │  • 이미지 저장  │  │ • PDF 파싱      │    │
│  │ • 불량 타입 관리│  │  • 전처리       │  │ • 벡터화         │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │  Model Manager  │  │ Defect Detector │  │  Guide Generator│    │
│  │ • CLIP 임베딩   │  │ • PatchCore     │  │ • RAG 검색      │    │
│  │ • 인덱스 구축   │  │ • Anomaly 검출  │  │ • LLM 생성      │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │ Feedback Manager│  │ Dashboard Service│ │ Deploy Manager  │    │
│  │ • 피드백 수집   │  │ • 통계 집계     │  │ • 배포 스케줄링 │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                           Data Layer                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │    RDBMS        │  │  File Storage   │  │  Vector Store   │    │
│  │  (PostgreSQL)   │  │   (NCP OBS)     │  │    (FAISS)      │    │
│  │                 │  │                 │  │                 │    │
│  │ • 제품 정보     │  │ • 이미지 파일   │  │ • CLIP 임베딩   │    │
│  │ • 불량 타입     │  │ • PDF 매뉴얼    │  │ • RAG 벡터 DB   │    │
│  │ • 사용자 정보   │  │ • 전처리 이미지 │  │ • 메모리뱅크    │    │
│  │ • 검사 이력     │  │ • 결과 이미지   │  │                 │    │
│  │ • 피드백 데이터 │  │                 │  │                 │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        AI/ML Models (GPU Server)                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │     CLIP     │  │  PatchCore   │  │  LLM/RAG     │             │
│  │  (ViT-B-32)  │  │  (Anomaly)   │  │ (Mistral-7B) │             │
│  │              │  │              │  │              │             │
│  │ • 유사도검색 │  │ • 이상검출   │  │ • 매뉴얼생성 │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐                                │
│  │ (Optional)   │  │ (Optional)   │                                │
│  │ YOLO/Object  │  │ 전처리 모듈  │                                │
│  │  Detection   │  │ (OpenCV)     │                                │
│  └──────────────┘  └──────────────┘                                │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 관리자 페이지 상세 설계

### 3.1 제품/매뉴얼 등록 관리

#### 기능
1. 제품/매뉴얼(PDF) 등록
2. 제품별 불량 유형 등록
   - 불량 명칭 (한글): 예) 긁힘, 기공, 버
   - 매핑명 (영문): 예) scratch, hole, burr
3. 제품명, 매뉴얼 파일, 불량 유형 수정/삭제

#### UI 구성
```
┌─────────────────────────────────────────────────┐
│ 제품 관리                                        │
├─────────────────────────────────────────────────┤
│ [+ 신규 제품 등록]                               │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 제품명: prod1                  [수정] [삭제]│ │
│ │ 설명: 주조 제품 A형                         │ │
│ │ 매뉴얼: prod1_manual.pdf       [다운로드]   │ │
│ │                                              │ │
│ │ 불량 유형:                                   │ │
│ │ • 기공 (hole)                  [수정] [삭제]│ │
│ │ • 버 (burr)                    [수정] [삭제]│ │
│ │ • 긁힘 (scratch)               [수정] [삭제]│ │
│ │ [+ 불량 유형 추가]                           │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 제품명: prod2                  [수정] [삭제]│ │
│ │ ...                                          │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 3.2 이미지 데이터 등록 관리

#### 기능
1. 제품 선택
2. 정상 이미지 데이터 등록 (이미지 파일 or ZIP)
3. 불량 이미지 데이터 등록 (이미지 파일 or ZIP)
4. 서버 업로드 (OBS)

#### UI 구성
```
┌─────────────────────────────────────────────────┐
│ 이미지 데이터 관리                               │
├─────────────────────────────────────────────────┤
│ 제품 선택: [prod1 ▼]                            │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 정상 이미지                                  │ │
│ │ 등록된 이미지: 30장                          │ │
│ │ [파일 선택] [ZIP 업로드]      [업로드]       │ │
│ │                                              │ │
│ │ 미리보기:                                    │ │
│ │ [썸네일1] [썸네일2] [썸네일3] ...            │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 불량 이미지                                  │ │
│ │                                              │ │
│ │ • hole: 15장              [파일 선택] [삭제]│ │
│ │ • burr: 20장              [파일 선택] [삭제]│ │
│ │ • scratch: 10장           [파일 선택] [삭제]│ │
│ │                                              │ │
│ │ [일괄 업로드]                                │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 3.3 서버 배포 관리

#### 기능
1. CLIP 임베딩 재구축
2. PatchCore 메모리뱅크 생성
3. 배포 진행 상황 모니터링

#### UI 구성
```
┌─────────────────────────────────────────────────┐
│ 서버 배포                                        │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ CLIP 임베딩 재구축                           │ │
│ │ 상태: ● 완료 (2025-11-09 14:30)             │ │
│ │ 인덱스 크기: 50장 / 512차원                  │ │
│ │ [재구축 시작]                                │ │
│ │                                              │ │
│ │ 진행률: ████████████████████ 100%            │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ PatchCore 메모리뱅크 생성                    │ │
│ │ 상태: ○ 대기중                               │ │
│ │                                              │ │
│ │ • prod1: ● 완료 (614 패치)                  │ │
│ │ • prod2: ○ 미생성                           │ │
│ │ • prod3: ○ 미생성                           │ │
│ │                                              │ │
│ │ [배포 시작]                                  │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 배포 이력                                    │ │
│ │ 2025-11-09 14:30 | CLIP 재구축 | 성공       │ │
│ │ 2025-11-08 10:15 | PatchCore | 성공         │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 3.4 불량 검출 모델 선정

#### 기능
1. 정상 이미지 기반 모델 선택 (Anomaly / Object Detection)
2. 이미지 전처리 방법 선택
3. Object Detection 선택 시 라벨링 단계로 진입
4. Anomaly Detection 선택 시 Threshold/파라미터 지정

#### UI 구성
```
┌─────────────────────────────────────────────────┐
│ 불량 검출 모델 설정                              │
├─────────────────────────────────────────────────┤
│ 제품 선택: [prod1 ▼]                            │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 모델 선택                                    │ │
│ │ ◉ Anomaly Detection (PatchCore)             │ │
│ │ ○ Object Detection (YOLO)                   │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 이미지 전처리                                │ │
│ │ ☑ Grayscale                                 │ │
│ │ ☐ Contrast Enhancement                      │ │
│ │ ☐ Histogram Equalization                    │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ PatchCore 파라미터                           │ │
│ │ Image Threshold: [0.85__________] 0.85      │ │
│ │ Pixel Threshold:  [0.90__________] 0.90     │ │
│ │                                              │ │
│ │ [테스트 실행] [저장]                         │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 3.5 통합 대시보드

#### 기능
1. 등록 데이터셋 모니터링
2. 검사 수, 불량 감지 수, 조치 수
3. 조치 완료/미조치 사항 리스트
4. 바로가기 기능

#### UI 구성
```
┌─────────────────────────────────────────────────┐
│ 통합 대시보드                                    │
├─────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│ │ 등록제품 │ │ 총검사수 │ │ 불량검출 │         │
│ │    3개   │ │  1,234건 │ │   156건  │         │
│ └──────────┘ └──────────┘ └──────────┘         │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 제품별 데이터 현황                           │ │
│ │ ┌─────────────────────────────────────────┐│ │
│ │ │ prod1  정상:30  불량:45 (hole:15,burr:20)││ │
│ │ │ prod2  정상:25  불량:30 (scratch:30)    ││ │
│ │ │ prod3  정상:20  불량:0                   ││ │
│ │ └─────────────────────────────────────────┘│ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 최근 검사 이력                               │ │
│ │ 일시        | 제품  | 결과   | 조치상태     │ │
│ │ 11-09 14:35 | prod1 | 불량   | ● 조치완료  │ │
│ │ 11-09 14:20 | prod1 | 정상   | -           │ │
│ │ 11-09 14:10 | prod2 | 불량   | ○ 미조치    │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 미조치 사항 (2건)                            │ │
│ │ • [prod1] hole 검출 - 11-09 10:30  [바로가기]│ │
│ │ • [prod2] scratch - 11-09 14:10    [바로가기]│ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

---

## 4. 작업자 페이지 상세 설계

### 4.1 이미지 업로드
```
┌─────────────────────────────────────────────────┐
│ 검사 이미지 업로드                               │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │     [카메라 아이콘]                          │ │
│ │                                              │ │
│ │   이미지를 촬영하거나 업로드하세요            │ │
│ │                                              │ │
│ │   [📷 카메라 촬영] [📁 파일 선택]            │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 촬영 가이드:                                 │ │
│ │ • 조명이 균일한 환경에서 촬영                │ │
│ │ • 제품 전체가 프레임에 포함되도록            │ │
│ │ • 흔들림 없이 정면에서 촬영                  │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 4.2 유사도 검색 (TOP-K)
```
┌─────────────────────────────────────────────────┐
│ 유사 이미지 검색                                 │
├─────────────────────────────────────────────────┤
│ ┌───────────────┐   ┌───────────────┐           │
│ │   업로드      │   │  유사도 1위   │           │
│ │   이미지      │   │               │           │
│ │               │   │  (98.5%)      │           │
│ │               │   │  [선택]       │           │
│ └───────────────┘   └───────────────┘           │
│                                                  │
│ 기타 유사 이미지:                                │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐               │
│ │ 2위 │ │ 3위 │ │ 4위 │ │ 5위 │               │
│ │95.2%│ │92.8%│ │90.1%│ │88.5%│               │
│ └─────┘ └─────┘ └─────┘ └─────┘               │
│                                                  │
│ [유사 이미지 없음 - 신규 등록 요청]              │
└─────────────────────────────────────────────────┘
```

### 4.3 불량 검출 시각화
```
┌─────────────────────────────────────────────────┐
│ 정상 이미지 대조                                 │
├─────────────────────────────────────────────────┤
│ ┌───────────────┐   ┌───────────────┐           │
│ │   정상 기준   │   │  검사 이미지  │           │
│ │               │   │               │           │
│ │               │   │  [불량영역]   │           │
│ │               │   │   하이라이트  │           │
│ └───────────────┘   └───────────────┘           │
│                                                  │
│ 오버레이 이미지:                                 │
│ ┌───────────────────────────────────┐           │
│ │      [차이 영역 표시]             │           │
│ │       (히트맵)                    │           │
│ └───────────────────────────────────┘           │
│                                                  │
│ 불량 추론 결과:                                  │
│ • hole    (확률: 85%)  ◉ 선택                   │
│ • burr    (확률: 12%)  ○                        │
│ • scratch (확률: 3%)   ○                        │
│                                                  │
│ [불량 확정] [추론 실패 - 신규 등록]              │
└─────────────────────────────────────────────────┘
```

### 4.4 조치 가이드 생성
```
┌─────────────────────────────────────────────────┐
│ AI 조치 가이드                                   │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ 【현상 (What)】                              │ │
│ │ 제품 표면에 직경 약 2mm 크기의 기공이       │ │
│ │ 발견되었습니다.                              │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 【원인 (Why)】                               │ │
│ │ 1. 주조 시 금속 내부의 가스가 빠져나가지     │ │
│ │    못하고 갇혀 형성됨                        │ │
│ │ 2. 주조 온도가 너무 높거나 냉각 속도가       │ │
│ │    부적절한 경우                             │ │
│ │                                              │ │
│ │ 📄 근거: prod1_manual.pdf (p.12, 섹션 3.2)  │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 【조치 (How)】                               │ │
│ │ 1. 주조 온도를 10~15°C 낮춰 재시도           │ │
│ │ 2. 탈기 처리 시간을 2분 연장                 │ │
│ │ 3. 냉각 속도를 점진적으로 조절               │ │
│ │ 4. 금형의 통기구 상태 점검 및 청소           │ │
│ │                                              │ │
│ │ 📄 근거: prod1_manual.pdf (p.13, 섹션 3.3)  │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ [조치 완료] [매뉴얼 다운로드]                    │
└─────────────────────────────────────────────────┘
```

### 4.5 피드백 등록
```
┌─────────────────────────────────────────────────┐
│ 조치 기록 및 피드백                              │
├─────────────────────────────────────────────────┤
│ 조치 내용 기록:                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 주조 온도를 15°C 낮추고 탈기 시간을         │ │
│ │ 2분 연장하여 재작업 수행. 불량 해결됨.      │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ 가이드 유용성 평가:                              │
│ ★★★★★ (5점)                                    │
│                                                  │
│ [저장하고 완료]                                  │
└─────────────────────────────────────────────────┘
```

---

## 5. 데이터 흐름

### 5.1 관리자 - 제품 등록 흐름
```
1. 제품 정보 입력 → RDBMS (products 테이블)
2. 매뉴얼 PDF 업로드 → OBS 저장 → 경로 RDBMS 저장
3. 불량 유형 등록 → RDBMS (defect_types 테이블)
4. 정상 이미지 업로드 → OBS 저장 → 경로 RDBMS 저장
5. 불량 이미지 업로드 → OBS 저장 → 경로 RDBMS 저장
```

### 5.2 관리자 - 서버 배포 흐름
```
1. [CLIP 재구축] 버튼 클릭
   → 이미지 목록 조회 (RDBMS)
   → 이미지 로드 (OBS)
   → CLIP 임베딩 생성
   → FAISS 인덱스 저장
   → 배포 상태 업데이트 (RDBMS)

2. [PatchCore 생성] 버튼 클릭
   → 정상 이미지 목록 조회 (RDBMS)
   → 이미지 로드 (OBS)
   → PatchCore 메모리뱅크 생성
   → 메모리뱅크 저장 (Vector Store)
   → 배포 상태 업데이트 (RDBMS)
```

### 5.3 작업자 - 불량 검출 흐름
```
1. 이미지 업로드 → OBS 저장
2. CLIP 유사도 검색 → TOP-K 결과 반환
3. 사용자 이미지 선택
4. PatchCore 이상 검출 → 히트맵/마스크 생성
5. 불량 타입 추론 → 결과 제시
6. 사용자 불량 확정
7. RAG 매뉴얼 검색 → 관련 섹션 추출
8. LLM 조치 가이드 생성 → 결과 표시
9. 조치 기록 → RDBMS 저장
10. 피드백 입력 → RDBMS 저장
```

---

## 6. 기술 스택

### 6.1 현재 구축 (PoC 단계)
```
Frontend:  HTML5, JavaScript, CSS3
Backend:   FastAPI (Python 3.9)
Database:  (없음 - 파일 기반)
Storage:   로컬 파일 시스템
AI/ML:     CLIP, PatchCore, Mistral-7B LLM
Infra:     NCP GPU Server (Tesla T4 x2)
```

### 6.2 확장 구성 (향후)
```
Frontend:  React.js or Vue.js
Backend:   FastAPI + Celery (비동기 작업)
Database:  PostgreSQL (주 DB)
Cache:     Redis (세션, 캐시)
Storage:   NCP Object Storage
Message:   RabbitMQ or Redis (작업 큐)
Monitor:   Grafana + Prometheus
AI/ML:     MLflow (모델 관리)
```

---

## 7. 개선 사항 및 확장 계획

### 7.1 단기 (1개월)
- [ ] PostgreSQL RDBMS 구축
- [ ] 관리자 페이지 개발 (제품/매뉴얼/이미지 관리)
- [ ] 작업자 페이지 개선 (피드백 시스템)
- [ ] 통합 대시보드 구축
- [ ] NCP OBS 연동

### 7.2 중기 (3개월)
- [ ] 사용자 인증/권한 시스템
- [ ] Object Detection 모델 통합 (YOLO)
- [ ] 라벨링 도구 개발
- [ ] 배치 처리 시스템 (Celery)
- [ ] 이미지 전처리 파이프라인

### 7.3 장기 (6개월 이상)
- [ ] 업체별 프로젝트 관리
- [ ] Active Learning 파이프라인
- [ ] 모바일 앱 개발
- [ ] 실시간 생산라인 통합
- [ ] AI 모델 자동 재학습

---

**작성일**: 2025-11-09  
**버전**: 1.2  
**기반 문서**: LLM_화면_개발_가이드_ver_1_2.xlsx
